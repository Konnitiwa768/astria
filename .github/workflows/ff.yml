name: Nether Star Armor Texture Clip & Convert

on:
  push:
    branches:
      - Battlity
  pull_request:
    branches:
      - Battlity
  workflow_dispatch:

jobs:
  armor_texture_process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      # オリジナル画像DL
      - name: Download original images
        run: |
          for item in helmet chestplate leggings boots; do
            curl -L -o "nether_star_${item}.png" "https://raw.githubusercontent.com/Konnitiwa768/Morearmors/main/src/main/resources/assets/morearmors/textures/items/nether_star_${item}.png"
          done

      # Nether Star clip（元画像の不透明部分だけをくり抜く）
      - name: Clip original images (opaque only)
        run: |
          mkdir -p resourcepack/assets/kubejs/textures/item
          for item in helmet chestplate leggings boots; do
            convert "nether_star_${item}.png" -alpha extract mask.png
            convert "nether_star_${item}.png" mask.png -alpha off -compose CopyOpacity -composite \
              "resourcepack/assets/kubejs/textures/item/nether_star_${item}_opaqueclip.png"
            rm mask.png
          done

      # 色相変更によるリカラー画像の生成とclip
      - name: Convert and clip recolor images (hue shift)
        run: |
          set -e
          mkdir -p resourcepack/assets/kubejs/textures/item

          # recolor: 色相シフトで色変更
          recolor() {
            src=$1
            hue_shift=$2
            prefix=$3
            part=$4
            out="resourcepack/assets/kubejs/textures/item/${prefix}_${part}.png"
            convert "$src" -resize 16x16^ -gravity center -extent 16x16 \
              -alpha on -modulate 100,100,"$hue_shift" "$out"
          }

          # くり抜きclip関数
          clip_opaque() {
            input_img=$1
            output_img=$2
            convert "$input_img" -alpha extract mask.png
            convert "$input_img" mask.png -alpha off -compose CopyOpacity -composite "$output_img"
            rm mask.png
          }

          declare -A PREFIXES=(
            [demlight]="demlight"
            [provarm]="provarm"
            [spectrium]="spectrium"
          )

          # 色相シフト値（目安。必要に応じて調整OK）
          declare -A HUES=(
            [demlight]=160     # 水色→紫（+60度程度）
            [provarm]=240      # 水色→赤（+140度程度）
            [spectrium]=40     # 水色→黄緑～黄（+40度程度、好みに合わせて調整）
          )

          for item in helmet chestplate leggings boots; do
            for prefix in demlight provarm spectrium; do
              recolor "nether_star_${item}.png" "${HUES[$prefix]}" "${PREFIXES[$prefix]}" "$item"
            done

            for prefix in demlight provarm spectrium; do
              src="resourcepack/assets/kubejs/textures/item/${prefix}_${item}.png"
              out="resourcepack/assets/kubejs/textures/item/${prefix}_${item}_opaqueclip.png"
              clip_opaque "$src" "$out"
            done
          done

      # 自動コミット＆push前にpull --rebase
      - name: Commit and push all images safely
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add resourcepack/assets/kubejs/textures/item
          git commit -m "auto: clip & convert armor textures (all hue-shift recolor)" || echo "No changes to commit"
          git pull --rebase origin Battlity
          git push origin HEAD:Battlity
